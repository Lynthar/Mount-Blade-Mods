<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CE Event Editor - CaptivityEvents å¯è§†åŒ–äº‹ä»¶ç¼–è¾‘å™¨</title>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --accent: #e94560;
            --accent-hover: #ff6b6b;
            --text-primary: #eaeaea;
            --text-secondary: #a0a0a0;
            --border: #2a2a4a;
            --success: #4ade80;
            --warning: #fbbf24;
            --error: #f87171;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-size: 1.4rem;
            color: var(--accent);
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-success {
            background: var(--success);
            color: #1a1a2e;
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 52px);
        }

        /* Left Panel - Event List */
        .panel-left {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h3 {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .event-search {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
        }

        .event-search input {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .event-search input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .event-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .event-item {
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .event-item:hover {
            border-color: var(--border);
        }

        .event-item.active {
            border-color: var(--accent);
        }

        .event-item .event-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
            word-break: break-all;
        }

        .event-item .event-type {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .event-type-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-right: 4px;
        }

        .tag-random { background: #3b82f6; }
        .tag-captor { background: #f59e0b; }
        .tag-captive { background: #8b5cf6; }
        .tag-chain { background: #6b7280; }

        /* Center Panel - Editor */
        .panel-center {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .editor-tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .editor-tab:hover {
            color: var(--text-primary);
        }

        .editor-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .editor-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-section {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-section h4 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            color: var(--accent);
        }

        /* Flags Section */
        .flags-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }

        .flag-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--bg-primary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .flag-item:hover {
            background: var(--bg-tertiary);
        }

        .flag-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
        }

        .flag-item label {
            font-size: 0.85rem;
            cursor: pointer;
            margin: 0;
        }

        /* Options Section */
        .options-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .option-card {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border);
        }

        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .option-header h5 {
            color: var(--accent);
        }

        .option-card .form-group {
            margin-bottom: 12px;
        }

        /* Right Panel - Event Chain Visualizer */
        .panel-right {
            width: 350px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .chain-visualizer {
            flex: 1;
            padding: 15px;
            overflow: auto;
        }

        .chain-node {
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            position: relative;
        }

        .chain-node.current {
            border-color: var(--accent);
        }

        .chain-node .node-name {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 6px;
        }

        .chain-node .node-options {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .chain-arrow {
            text-align: center;
            color: var(--text-secondary);
            padding: 5px 0;
        }

        .chain-children {
            margin-left: 20px;
            padding-left: 15px;
            border-left: 2px dashed var(--border);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-align: center;
            padding: 40px;
        }

        .empty-state h3 {
            margin-bottom: 10px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: var(--accent);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* XML Preview */
        .xml-preview {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 4px solid var(--success);
            display: none;
            z-index: 1001;
        }

        .toast.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Help tooltip */
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--bg-tertiary);
            border-radius: 50%;
            font-size: 0.7rem;
            cursor: help;
            margin-left: 6px;
        }

        .consequence-select {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .consequence-tag {
            padding: 4px 10px;
            background: var(--bg-primary);
            border-radius: 4px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .consequence-tag .remove {
            cursor: pointer;
            color: var(--error);
        }

        .add-consequence {
            position: relative;
        }

        .consequence-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            width: 250px;
            display: none;
            z-index: 100;
        }

        .consequence-dropdown.show {
            display: block;
        }

        .consequence-dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .consequence-dropdown-item:hover {
            background: var(--bg-tertiary);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>CE Event Editor - CaptivityEvents å¯è§†åŒ–äº‹ä»¶ç¼–è¾‘å™¨</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="importXML()">
                <span>ğŸ“‚</span> å¯¼å…¥XML
            </button>
            <button class="btn btn-secondary" onclick="exportXML()">
                <span>ğŸ’¾</span> å¯¼å‡ºXML
            </button>
            <button class="btn btn-primary" onclick="previewXML()">
                <span>ğŸ‘</span> é¢„è§ˆXML
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Panel - Event List -->
        <div class="panel-left">
            <div class="panel-header">
                <h3>äº‹ä»¶åˆ—è¡¨</h3>
                <button class="btn btn-primary" onclick="createNewEvent()">+ æ–°å»º</button>
            </div>
            <div class="event-search">
                <input type="text" id="eventSearch" placeholder="æœç´¢äº‹ä»¶..." oninput="filterEvents()">
            </div>
            <div class="event-list" id="eventList">
                <!-- Events will be rendered here -->
            </div>
        </div>

        <!-- Center Panel - Editor -->
        <div class="panel-center">
            <div class="editor-tabs">
                <div class="editor-tab active" data-tab="basic" onclick="switchTab('basic')">åŸºæœ¬ä¿¡æ¯</div>
                <div class="editor-tab" data-tab="flags" onclick="switchTab('flags')">æ¡ä»¶æ ‡å¿—</div>
                <div class="editor-tab" data-tab="options" onclick="switchTab('options')">é€‰é¡¹é…ç½®</div>
                <div class="editor-tab" data-tab="advanced" onclick="switchTab('advanced')">é«˜çº§è®¾ç½®</div>
            </div>
            <div class="editor-content" id="editorContent">
                <div class="empty-state" id="emptyState">
                    <h3>ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ CE Event Editor</h3>
                    <p>ç‚¹å‡»å·¦ä¾§"æ–°å»º"æŒ‰é’®åˆ›å»ºäº‹ä»¶<br>æˆ–"å¯¼å…¥XML"åŠ è½½ç°æœ‰äº‹ä»¶æ–‡ä»¶</p>
                </div>

                <!-- Basic Tab -->
                <div id="tab-basic" class="tab-content" style="display: none;">
                    <div class="form-section">
                        <h4>ğŸ“ åŸºæœ¬ä¿¡æ¯</h4>
                        <div class="form-group">
                            <label>äº‹ä»¶åç§° (å”¯ä¸€æ ‡è¯†ç¬¦) <span class="help-icon" title="ç”¨äºè¯†åˆ«å’Œå¼•ç”¨æ­¤äº‹ä»¶">?</span></label>
                            <input type="text" id="eventName" placeholder="ä¾‹å¦‚: MY_custom_event_001" oninput="updateCurrentEvent()">
                        </div>
                        <div class="form-group">
                            <label>äº‹ä»¶æ–‡æœ¬ <span class="help-icon" title="äº‹ä»¶å‘ç”Ÿæ—¶æ˜¾ç¤ºçš„æè¿°æ–‡å­—">?</span></label>
                            <textarea id="eventText" placeholder="æè¿°äº‹ä»¶å‘ç”Ÿçš„æƒ…æ™¯..." oninput="updateCurrentEvent()"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>èƒŒæ™¯å›¾ç‰‡åç§°</label>
                                <input type="text" id="eventBackground" placeholder="default_random" oninput="updateCurrentEvent()">
                            </div>
                            <div class="form-group">
                                <label>è§¦å‘æƒé‡ <span class="help-icon" title="æ•°å€¼è¶Šå¤§ï¼Œäº‹ä»¶è¶Šå®¹æ˜“è¢«è§¦å‘">?</span></label>
                                <input type="number" id="eventWeight" value="10" min="1" max="100" oninput="updateCurrentEvent()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>æœ€å°å¹´é¾„é™åˆ¶</label>
                                <input type="number" id="eventMinAge" value="18" min="0" oninput="updateCurrentEvent()">
                            </div>
                            <div class="form-group">
                                <label>æœ€å¤§å¹´é¾„é™åˆ¶</label>
                                <input type="number" id="eventMaxAge" placeholder="æ— é™åˆ¶" min="0" oninput="updateCurrentEvent()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Flags Tab -->
                <div id="tab-flags" class="tab-content" style="display: none;">
                    <div class="form-section">
                        <h4>ğŸ¯ äº‹ä»¶ç±»å‹ (å¿…é€‰å…¶ä¸€)</h4>
                        <div class="flags-grid">
                            <div class="flag-item">
                                <input type="radio" id="flagRandom" name="eventType" value="Random" onchange="updateCurrentEvent()">
                                <label for="flagRandom">Random (éšæœºäº‹ä»¶)</label>
                            </div>
                            <div class="flag-item">
                                <input type="radio" id="flagCaptor" name="eventType" value="Captor" onchange="updateCurrentEvent()">
                                <label for="flagCaptor">Captor (ä¿˜è™è€…äº‹ä»¶)</label>
                            </div>
                            <div class="flag-item">
                                <input type="radio" id="flagCaptive" name="eventType" value="Captive" onchange="updateCurrentEvent()">
                                <label for="flagCaptive">Captive (è¢«ä¿˜äº‹ä»¶)</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>ğŸ“ ä½ç½®æ¡ä»¶</h4>
                        <div class="flags-grid" id="locationFlags">
                            <!-- Location flags will be rendered here -->
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>â° æ—¶é—´æ¡ä»¶</h4>
                        <div class="flags-grid" id="timeFlags">
                            <!-- Time flags will be rendered here -->
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>ğŸ‘¤ è§’è‰²æ¡ä»¶</h4>
                        <div class="flags-grid" id="characterFlags">
                            <!-- Character flags will be rendered here -->
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>âš™ï¸ å…¶ä»–æ ‡å¿—</h4>
                        <div class="flags-grid" id="otherFlags">
                            <!-- Other flags will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Options Tab -->
                <div id="tab-options" class="tab-content" style="display: none;">
                    <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; border: none; padding: 0;">ğŸ® ç©å®¶é€‰é¡¹</h4>
                            <button class="btn btn-primary" onclick="addOption()">+ æ·»åŠ é€‰é¡¹</button>
                        </div>
                        <div class="options-list" id="optionsList">
                            <!-- Options will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Advanced Tab -->
                <div id="tab-advanced" class="tab-content" style="display: none;">
                    <div class="form-section">
                        <h4>ğŸ”— äº‹ä»¶é“¾è®¾ç½®</h4>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="isChainOnly" onchange="updateCurrentEvent()">
                                åªèƒ½è¢«å…¶ä»–äº‹ä»¶è§¦å‘ (CanOnlyBeTriggeredByOtherEvent)
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="isOverwritable" onchange="updateCurrentEvent()">
                                å…è®¸è¢«è¦†å†™ (Overwritable)
                            </label>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>ğŸ“Š æ•°å€¼è¦æ±‚</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>éœ€è¦é‡‘å¸ ></label>
                                <input type="number" id="reqGoldAbove" placeholder="æ— è¦æ±‚" oninput="updateCurrentEvent()">
                            </div>
                            <div class="form-group">
                                <label>éœ€è¦é‡‘å¸ &lt;</label>
                                <input type="number" id="reqGoldBelow" placeholder="æ— è¦æ±‚" oninput="updateCurrentEvent()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>éœ€è¦ä¿˜è™æ•° ></label>
                                <input type="number" id="reqCaptivesAbove" placeholder="æ— è¦æ±‚" oninput="updateCurrentEvent()">
                            </div>
                            <div class="form-group">
                                <label>éœ€è¦å£«å…µæ•° ></label>
                                <input type="number" id="reqTroopsAbove" placeholder="æ— è¦æ±‚" oninput="updateCurrentEvent()">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>ğŸ² é€ƒè·‘ä¸æ€€å­•è®¾ç½®</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>é€ƒè·‘å‡ ç‡ (%)</label>
                                <input type="number" id="escapeChance" placeholder="æ— " min="0" max="100" oninput="updateCurrentEvent()">
                            </div>
                            <div class="form-group">
                                <label>æ€€å­•é£é™©ä¿®æ­£</label>
                                <input type="number" id="pregnancyRisk" placeholder="æ— " oninput="updateCurrentEvent()">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>ğŸ—‘ï¸ å±é™©æ“ä½œ</h4>
                        <button class="btn btn-danger" onclick="deleteCurrentEvent()">åˆ é™¤æ­¤äº‹ä»¶</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Event Chain -->
        <div class="panel-right">
            <div class="panel-header">
                <h3>äº‹ä»¶é“¾å¯è§†åŒ–</h3>
            </div>
            <div class="chain-visualizer" id="chainVisualizer">
                <div class="empty-state">
                    <p>é€‰æ‹©ä¸€ä¸ªäº‹ä»¶<br>æŸ¥çœ‹å…¶äº‹ä»¶é“¾</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal">
            <h3>ğŸ“‚ å¯¼å…¥ XML æ–‡ä»¶</h3>
            <div class="form-group">
                <label>é€‰æ‹© XML æ–‡ä»¶</label>
                <input type="file" id="xmlFileInput" accept=".xml">
            </div>
            <div class="form-group">
                <label>æˆ–ç²˜è´´ XML å†…å®¹</label>
                <textarea id="xmlPasteInput" placeholder="ç²˜è´´ XML å†…å®¹..." style="min-height: 200px;"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('importModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="doImport()">å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal-overlay" id="previewModal">
        <div class="modal" style="max-width: 900px;">
            <h3>ğŸ‘ XML é¢„è§ˆ</h3>
            <div class="xml-preview" id="xmlPreviewContent">
                <!-- XML content will be shown here -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('previewModal')">å…³é—­</button>
                <button class="btn btn-primary" onclick="copyXML()">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
                <button class="btn btn-success" onclick="downloadXML()">ä¸‹è½½æ–‡ä»¶</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ==================== Data Definitions ====================
        const FLAG_CATEGORIES = {
            location: [
                { id: 'LocationLand', label: 'é™†åœ°' },
                { id: 'LocationSea', label: 'æµ·ä¸Š' },
                { id: 'LocationTravellingParty', label: 'è¡Œå†›é€”ä¸­' },
                { id: 'LocationCity', label: 'åŸå¸‚' },
                { id: 'LocationCastle', label: 'åŸå ¡' },
                { id: 'LocationVillage', label: 'æ‘åº„' },
                { id: 'LocationDungeon', label: 'åœ°ç‰¢' },
                { id: 'LocationTavern', label: 'é…’é¦†' },
                { id: 'LocationHideout', label: 'åŒªçª' },
                { id: 'LocationPartyInTown', label: 'é˜Ÿä¼åœ¨åŸé•‡' },
                { id: 'LocationPartyInCastle', label: 'é˜Ÿä¼åœ¨åŸå ¡' },
                { id: 'LocationPartyInVillage', label: 'é˜Ÿä¼åœ¨æ‘åº„' },
            ],
            time: [
                { id: 'TimeDay', label: 'ç™½å¤©' },
                { id: 'TimeNight', label: 'å¤œæ™š' },
                { id: 'SeasonSpring', label: 'æ˜¥å­£' },
                { id: 'SeasonSummer', label: 'å¤å­£' },
                { id: 'SeasonFall', label: 'ç§‹å­£' },
                { id: 'SeasonWinter', label: 'å†¬å­£' },
            ],
            character: [
                { id: 'HeroGenderIsFemale', label: 'ä¸»è§’æ˜¯å¥³æ€§' },
                { id: 'HeroGenderIsMale', label: 'ä¸»è§’æ˜¯ç”·æ€§' },
                { id: 'CaptorGenderIsFemale', label: 'ä¿˜è™è€…æ˜¯å¥³æ€§' },
                { id: 'CaptorGenderIsMale', label: 'ä¿˜è™è€…æ˜¯ç”·æ€§' },
                { id: 'HeroIsPregnant', label: 'ä¸»è§’æ€€å­•' },
                { id: 'HeroIsNotPregnant', label: 'ä¸»è§’æœªæ€€å­•' },
                { id: 'HeroHaveSpouse', label: 'ä¸»è§’æœ‰é…å¶' },
                { id: 'HeroNotHaveSpouse', label: 'ä¸»è§’æ— é…å¶' },
                { id: 'CaptorIsHero', label: 'ä¿˜è™è€…æ˜¯è‹±é›„' },
                { id: 'CaptorIsNonHero', label: 'ä¿˜è™è€…éè‹±é›„' },
            ],
            other: [
                { id: 'Common', label: 'é€šç”¨äº‹ä»¶' },
                { id: 'BanditParty', label: 'åœŸåŒªé˜Ÿä¼' },
                { id: 'LordParty', label: 'é¢†ä¸»é˜Ÿä¼' },
                { id: 'CaravanParty', label: 'å•†é˜Ÿ' },
                { id: 'PlayerIsNotBusy', label: 'ç©å®¶ä¸å¿™ç¢Œ' },
                { id: 'StripEnabled', label: 'å¯ç”¨å‰¥å¤º' },
                { id: 'DuringSiege', label: 'å›´åŸæœŸé—´' },
                { id: 'DuringRaid', label: 'åŠ«æ æœŸé—´' },
            ]
        };

        const CONSEQUENCES = [
            { id: 'Continue', label: 'ç»§ç»­' },
            { id: 'Leave', label: 'ç¦»å¼€' },
            { id: 'Escape', label: 'é€ƒè·‘æˆåŠŸ' },
            { id: 'AttemptEscape', label: 'å°è¯•é€ƒè·‘' },
            { id: 'ChangeGold', label: 'æ”¹å˜é‡‘å¸' },
            { id: 'GiveGold', label: 'ç»™äºˆé‡‘å¸' },
            { id: 'ChangeHealth', label: 'æ”¹å˜ç”Ÿå‘½' },
            { id: 'ChangeRenown', label: 'æ”¹å˜å£°æœ›' },
            { id: 'ChangeMorale', label: 'æ”¹å˜å£«æ°”' },
            { id: 'ChangeRelation', label: 'æ”¹å˜å…³ç³»' },
            { id: 'ReleaseRandomPrisoners', label: 'é‡Šæ”¾éšæœºä¿˜è™' },
            { id: 'ReleaseAllPrisoners', label: 'é‡Šæ”¾å…¨éƒ¨ä¿˜è™' },
            { id: 'KillPrisoner', label: 'æ€æ­»ä¿˜è™' },
            { id: 'WoundPrisoner', label: 'ä¼¤å®³ä¿˜è™' },
            { id: 'JoinCaptor', label: 'åŠ å…¥ä¿˜è™è€…' },
            { id: 'Strip', label: 'å‰¥å¤ºè£…å¤‡' },
            { id: 'StartBattle', label: 'å¼€å§‹æˆ˜æ–—' },
            { id: 'Wait', label: 'ç­‰å¾…' },
            { id: 'EmptyIcon', label: 'ç©ºå›¾æ ‡' },
            { id: 'GainRandomPrisoners', label: 'è·å¾—éšæœºä¿˜è™' },
            { id: 'ImpregnationRisk', label: 'æ€€å­•é£é™©' },
            { id: 'TeleportPlayer', label: 'ä¼ é€ç©å®¶' },
        ];

        // ==================== State Management ====================
        let events = [];
        let currentEventIndex = -1;

        // ==================== Initialization ====================
        function init() {
            renderFlagCheckboxes();
            renderEventList();
        }

        function renderFlagCheckboxes() {
            renderFlagCategory('locationFlags', FLAG_CATEGORIES.location);
            renderFlagCategory('timeFlags', FLAG_CATEGORIES.time);
            renderFlagCategory('characterFlags', FLAG_CATEGORIES.character);
            renderFlagCategory('otherFlags', FLAG_CATEGORIES.other);
        }

        function renderFlagCategory(containerId, flags) {
            const container = document.getElementById(containerId);
            container.innerHTML = flags.map(flag => `
                <div class="flag-item">
                    <input type="checkbox" id="flag_${flag.id}" value="${flag.id}" onchange="updateCurrentEvent()">
                    <label for="flag_${flag.id}">${flag.label}</label>
                </div>
            `).join('');
        }

        // ==================== Event Management ====================
        function createNewEvent() {
            const newEvent = {
                name: `NEW_event_${Date.now()}`,
                text: '',
                background: 'default_random',
                weight: 10,
                minAge: 18,
                maxAge: null,
                eventType: 'Random',
                flags: [],
                options: [createDefaultOption(0)],
                isChainOnly: false,
                isOverwritable: true,
                reqGoldAbove: null,
                reqGoldBelow: null,
                reqCaptivesAbove: null,
                reqTroopsAbove: null,
                escapeChance: null,
                pregnancyRisk: null
            };
            events.push(newEvent);
            currentEventIndex = events.length - 1;
            renderEventList();
            selectEvent(currentEventIndex);
            showToast('æ–°äº‹ä»¶å·²åˆ›å»º');
        }

        function createDefaultOption(order) {
            return {
                order: order,
                text: 'ç»§ç»­...',
                consequences: ['Continue'],
                triggerEventName: '',
                triggerEvents: [],
                goldTotal: null,
                healthTotal: null,
                renownTotal: null,
                moraleTotal: null,
                escapeChance: null,
                skillsRequired: [],
                traitsRequired: []
            };
        }

        function selectEvent(index) {
            currentEventIndex = index;
            document.querySelectorAll('.event-item').forEach((el, i) => {
                el.classList.toggle('active', i === index);
            });

            if (index >= 0 && index < events.length) {
                document.getElementById('emptyState').style.display = 'none';
                document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
                document.getElementById('tab-basic').style.display = 'block';
                loadEventToForm(events[index]);
                renderEventChain();
            }
        }

        function loadEventToForm(event) {
            document.getElementById('eventName').value = event.name || '';
            document.getElementById('eventText').value = event.text || '';
            document.getElementById('eventBackground').value = event.background || '';
            document.getElementById('eventWeight').value = event.weight || 10;
            document.getElementById('eventMinAge').value = event.minAge || 18;
            document.getElementById('eventMaxAge').value = event.maxAge || '';

            // Event type
            document.querySelectorAll('input[name="eventType"]').forEach(el => {
                el.checked = el.value === event.eventType;
            });

            // Flags
            document.querySelectorAll('.flags-grid input[type="checkbox"]').forEach(el => {
                el.checked = event.flags && event.flags.includes(el.value);
            });

            // Chain settings
            document.getElementById('isChainOnly').checked = event.isChainOnly || false;
            document.getElementById('isOverwritable').checked = event.isOverwritable || false;

            // Requirements
            document.getElementById('reqGoldAbove').value = event.reqGoldAbove || '';
            document.getElementById('reqGoldBelow').value = event.reqGoldBelow || '';
            document.getElementById('reqCaptivesAbove').value = event.reqCaptivesAbove || '';
            document.getElementById('reqTroopsAbove').value = event.reqTroopsAbove || '';
            document.getElementById('escapeChance').value = event.escapeChance || '';
            document.getElementById('pregnancyRisk').value = event.pregnancyRisk || '';

            // Options
            renderOptions(event.options || []);
        }

        function updateCurrentEvent() {
            if (currentEventIndex < 0) return;

            const event = events[currentEventIndex];
            event.name = document.getElementById('eventName').value;
            event.text = document.getElementById('eventText').value;
            event.background = document.getElementById('eventBackground').value;
            event.weight = parseInt(document.getElementById('eventWeight').value) || 10;
            event.minAge = parseInt(document.getElementById('eventMinAge').value) || 18;
            event.maxAge = parseInt(document.getElementById('eventMaxAge').value) || null;

            // Event type
            const typeEl = document.querySelector('input[name="eventType"]:checked');
            event.eventType = typeEl ? typeEl.value : 'Random';

            // Flags
            event.flags = [];
            document.querySelectorAll('.flags-grid input[type="checkbox"]:checked').forEach(el => {
                event.flags.push(el.value);
            });

            // Chain settings
            event.isChainOnly = document.getElementById('isChainOnly').checked;
            event.isOverwritable = document.getElementById('isOverwritable').checked;

            // Requirements
            event.reqGoldAbove = parseInt(document.getElementById('reqGoldAbove').value) || null;
            event.reqGoldBelow = parseInt(document.getElementById('reqGoldBelow').value) || null;
            event.reqCaptivesAbove = parseInt(document.getElementById('reqCaptivesAbove').value) || null;
            event.reqTroopsAbove = parseInt(document.getElementById('reqTroopsAbove').value) || null;
            event.escapeChance = parseInt(document.getElementById('escapeChance').value) || null;
            event.pregnancyRisk = parseInt(document.getElementById('pregnancyRisk').value) || null;

            renderEventList();
            renderEventChain();
        }

        function deleteCurrentEvent() {
            if (currentEventIndex < 0) return;
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº‹ä»¶å—ï¼Ÿ')) return;

            events.splice(currentEventIndex, 1);
            currentEventIndex = -1;
            renderEventList();
            document.getElementById('emptyState').style.display = 'flex';
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            showToast('äº‹ä»¶å·²åˆ é™¤');
        }

        // ==================== Options Management ====================
        function renderOptions(options) {
            const container = document.getElementById('optionsList');
            if (!options || options.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">æš‚æ— é€‰é¡¹ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </p>';
                return;
            }

            container.innerHTML = options.map((opt, idx) => `
                <div class="option-card" data-index="${idx}">
                    <div class="option-header">
                        <h5>é€‰é¡¹ ${idx + 1}</h5>
                        <button class="btn btn-danger" onclick="removeOption(${idx})" style="padding: 4px 8px; font-size: 0.8rem;">åˆ é™¤</button>
                    </div>
                    <div class="form-group">
                        <label>é€‰é¡¹æ–‡æœ¬</label>
                        <input type="text" value="${escapeHtml(opt.text || '')}" onchange="updateOption(${idx}, 'text', this.value)">
                    </div>
                    <div class="form-group">
                        <label>åæœæ•ˆæœ</label>
                        <div class="consequence-select" id="consequences_${idx}">
                            ${(opt.consequences || []).map(c => `
                                <span class="consequence-tag">
                                    ${c}
                                    <span class="remove" onclick="removeConsequence(${idx}, '${c}')">&times;</span>
                                </span>
                            `).join('')}
                            <div class="add-consequence">
                                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem;" onclick="toggleConsequenceDropdown(${idx})">+ æ·»åŠ </button>
                                <div class="consequence-dropdown" id="conseqDropdown_${idx}">
                                    ${CONSEQUENCES.map(c => `
                                        <div class="consequence-dropdown-item" onclick="addConsequence(${idx}, '${c.id}')">${c.label} (${c.id})</div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>è§¦å‘äº‹ä»¶åç§°</label>
                            <input type="text" value="${opt.triggerEventName || ''}" placeholder="ç•™ç©ºè¡¨ç¤ºä¸è§¦å‘" onchange="updateOption(${idx}, 'triggerEventName', this.value)">
                        </div>
                        <div class="form-group">
                            <label>é‡‘å¸å˜åŒ–</label>
                            <input type="text" value="${opt.goldTotal || ''}" placeholder="ä¾‹å¦‚: -100 æˆ– R 50 200" onchange="updateOption(${idx}, 'goldTotal', this.value)">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ç”Ÿå‘½å˜åŒ–</label>
                            <input type="text" value="${opt.healthTotal || ''}" placeholder="ä¾‹å¦‚: -20" onchange="updateOption(${idx}, 'healthTotal', this.value)">
                        </div>
                        <div class="form-group">
                            <label>å£°æœ›å˜åŒ–</label>
                            <input type="text" value="${opt.renownTotal || ''}" placeholder="ä¾‹å¦‚: R 1 3" onchange="updateOption(${idx}, 'renownTotal', this.value)">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addOption() {
            if (currentEventIndex < 0) return;
            const event = events[currentEventIndex];
            if (!event.options) event.options = [];
            event.options.push(createDefaultOption(event.options.length));
            renderOptions(event.options);
        }

        function removeOption(idx) {
            if (currentEventIndex < 0) return;
            events[currentEventIndex].options.splice(idx, 1);
            // Reorder
            events[currentEventIndex].options.forEach((opt, i) => opt.order = i);
            renderOptions(events[currentEventIndex].options);
        }

        function updateOption(idx, field, value) {
            if (currentEventIndex < 0) return;
            events[currentEventIndex].options[idx][field] = value;
            renderEventChain();
        }

        function toggleConsequenceDropdown(idx) {
            const dropdown = document.getElementById(`conseqDropdown_${idx}`);
            dropdown.classList.toggle('show');
        }

        function addConsequence(optIdx, conseqId) {
            if (currentEventIndex < 0) return;
            const opt = events[currentEventIndex].options[optIdx];
            if (!opt.consequences) opt.consequences = [];
            if (!opt.consequences.includes(conseqId)) {
                opt.consequences.push(conseqId);
            }
            renderOptions(events[currentEventIndex].options);
        }

        function removeConsequence(optIdx, conseqId) {
            if (currentEventIndex < 0) return;
            const opt = events[currentEventIndex].options[optIdx];
            opt.consequences = opt.consequences.filter(c => c !== conseqId);
            renderOptions(events[currentEventIndex].options);
        }

        // ==================== UI Helpers ====================
        function renderEventList() {
            const container = document.getElementById('eventList');
            const searchTerm = document.getElementById('eventSearch').value.toLowerCase();

            const filtered = events.filter(e =>
                e.name.toLowerCase().includes(searchTerm) ||
                (e.text && e.text.toLowerCase().includes(searchTerm))
            );

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>æš‚æ— äº‹ä»¶</p></div>';
                return;
            }

            container.innerHTML = filtered.map((event, idx) => {
                const realIdx = events.indexOf(event);
                const typeTag = event.isChainOnly ? 'chain' : event.eventType.toLowerCase();
                return `
                    <div class="event-item ${realIdx === currentEventIndex ? 'active' : ''}" onclick="selectEvent(${realIdx})">
                        <div class="event-name">${escapeHtml(event.name)}</div>
                        <div class="event-type">
                            <span class="event-type-tag tag-${typeTag}">${event.isChainOnly ? 'é“¾å¼' : event.eventType}</span>
                            ${event.options ? event.options.length + 'ä¸ªé€‰é¡¹' : '0ä¸ªé€‰é¡¹'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterEvents() {
            renderEventList();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.editor-tab').forEach(el => {
                el.classList.toggle('active', el.dataset.tab === tabId);
            });
            document.querySelectorAll('.tab-content').forEach(el => {
                el.style.display = el.id === `tab-${tabId}` ? 'block' : 'none';
            });
        }

        function renderEventChain() {
            const container = document.getElementById('chainVisualizer');
            if (currentEventIndex < 0) {
                container.innerHTML = '<div class="empty-state"><p>é€‰æ‹©ä¸€ä¸ªäº‹ä»¶æŸ¥çœ‹å…¶äº‹ä»¶é“¾</p></div>';
                return;
            }

            const event = events[currentEventIndex];
            container.innerHTML = renderChainNode(event, true);
        }

        function renderChainNode(event, isCurrent = false) {
            const triggeredEvents = [];
            if (event.options) {
                event.options.forEach(opt => {
                    if (opt.triggerEventName) {
                        const triggered = events.find(e => e.name === opt.triggerEventName);
                        if (triggered && !triggeredEvents.includes(triggered)) {
                            triggeredEvents.push(triggered);
                        }
                    }
                });
            }

            let html = `
                <div class="chain-node ${isCurrent ? 'current' : ''}">
                    <div class="node-name">${escapeHtml(event.name)}</div>
                    <div class="node-options">${event.options ? event.options.length : 0}ä¸ªé€‰é¡¹</div>
                </div>
            `;

            if (triggeredEvents.length > 0) {
                html += '<div class="chain-arrow">â†“</div>';
                html += '<div class="chain-children">';
                triggeredEvents.forEach(te => {
                    html += renderChainNode(te, false);
                });
                html += '</div>';
            }

            return html;
        }

        // ==================== Import/Export ====================
        function importXML() {
            document.getElementById('importModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function doImport() {
            const fileInput = document.getElementById('xmlFileInput');
            const pasteInput = document.getElementById('xmlPasteInput');

            if (fileInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    parseAndImportXML(e.target.result);
                };
                reader.readAsText(fileInput.files[0]);
            } else if (pasteInput.value.trim()) {
                parseAndImportXML(pasteInput.value);
            } else {
                showToast('è¯·é€‰æ‹©æ–‡ä»¶æˆ–ç²˜è´´XMLå†…å®¹', 'error');
            }
        }

        function parseAndImportXML(xmlString) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(xmlString, 'text/xml');

                const errorNode = doc.querySelector('parsererror');
                if (errorNode) {
                    throw new Error('XMLè§£æé”™è¯¯');
                }

                const eventNodes = doc.querySelectorAll('CEEvent');
                let importedCount = 0;

                eventNodes.forEach(node => {
                    const event = parseEventNode(node);
                    events.push(event);
                    importedCount++;
                });

                closeModal('importModal');
                renderEventList();
                showToast(`æˆåŠŸå¯¼å…¥ ${importedCount} ä¸ªäº‹ä»¶`);

                // Clear inputs
                document.getElementById('xmlFileInput').value = '';
                document.getElementById('xmlPasteInput').value = '';
            } catch (e) {
                showToast('å¯¼å…¥å¤±è´¥: ' + e.message, 'error');
            }
        }

        function parseEventNode(node) {
            const getText = (tag) => {
                const el = node.querySelector(tag);
                return el ? el.textContent : '';
            };

            const event = {
                name: getText('Name'),
                text: getText('Text'),
                background: getText('BackgroundName'),
                weight: parseInt(getText('WeightedChanceOfOccurring')) || 10,
                minAge: parseInt(getText('ReqHeroMinAge')) || 18,
                maxAge: parseInt(getText('ReqHeroMaxAge')) || null,
                eventType: 'Random',
                flags: [],
                options: [],
                isChainOnly: false,
                isOverwritable: false
            };

            // Parse flags
            const flagNodes = node.querySelectorAll('RestrictedListOfFlags');
            flagNodes.forEach(fn => {
                const flag = fn.textContent;
                if (['Random', 'Captor', 'Captive'].includes(flag)) {
                    event.eventType = flag;
                } else if (flag === 'CanOnlyBeTriggeredByOtherEvent') {
                    event.isChainOnly = true;
                } else if (flag === 'Overwritable') {
                    event.isOverwritable = true;
                } else {
                    event.flags.push(flag);
                }
            });

            // Parse options
            const optionNodes = node.querySelectorAll('Option');
            optionNodes.forEach((optNode, idx) => {
                const opt = {
                    order: parseInt(optNode.querySelector('Order')?.textContent) || idx,
                    text: optNode.querySelector('OptionText')?.textContent || '',
                    consequences: [],
                    triggerEventName: optNode.querySelector('TriggerEventName')?.textContent || '',
                    goldTotal: optNode.querySelector('GoldTotal')?.textContent || null,
                    healthTotal: optNode.querySelector('HealthTotal')?.textContent || null,
                    renownTotal: optNode.querySelector('RenownTotal')?.textContent || null
                };

                optNode.querySelectorAll('RestrictedListOfConsequences').forEach(c => {
                    opt.consequences.push(c.textContent);
                });

                event.options.push(opt);
            });

            return event;
        }

        function generateXML() {
            let xml = `<?xml version="1.0" encoding="UTF-8"?>
<CEEvents xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="../zCaptivityEvents/ModuleLoader/CaptivityRequired/Events/CEEventsModal.xsd">

`;
            events.forEach(event => {
                xml += generateEventXML(event);
            });

            xml += '</CEEvents>\n';
            return xml;
        }

        function generateEventXML(event) {
            let xml = '    <CEEvent>\n';
            xml += `        <Name>${escapeXml(event.name)}</Name>\n`;
            xml += `        <Text>${escapeXml(event.text)}</Text>\n`;

            if (event.background) {
                xml += `        <BackgroundName>${escapeXml(event.background)}</BackgroundName>\n`;
            }

            // Flags
            xml += '        <MultipleRestrictedListOfFlags>\n';
            xml += `            <RestrictedListOfFlags>${event.eventType}</RestrictedListOfFlags>\n`;
            if (event.isChainOnly) {
                xml += '            <RestrictedListOfFlags>CanOnlyBeTriggeredByOtherEvent</RestrictedListOfFlags>\n';
            }
            if (event.isOverwritable) {
                xml += '            <RestrictedListOfFlags>Overwritable</RestrictedListOfFlags>\n';
            }
            event.flags.forEach(flag => {
                xml += `            <RestrictedListOfFlags>${flag}</RestrictedListOfFlags>\n`;
            });
            xml += '        </MultipleRestrictedListOfFlags>\n';

            // Options
            if (event.options && event.options.length > 0) {
                xml += '        <Options>\n';
                event.options.forEach(opt => {
                    xml += '            <Option>\n';
                    xml += `                <Order>${opt.order}</Order>\n`;
                    xml += '                <MultipleRestrictedListOfConsequences>\n';
                    opt.consequences.forEach(c => {
                        xml += `                    <RestrictedListOfConsequences>${c}</RestrictedListOfConsequences>\n`;
                    });
                    xml += '                </MultipleRestrictedListOfConsequences>\n';
                    xml += `                <OptionText>${escapeXml(opt.text)}</OptionText>\n`;

                    if (opt.triggerEventName) {
                        xml += `                <TriggerEventName>${escapeXml(opt.triggerEventName)}</TriggerEventName>\n`;
                    }
                    if (opt.goldTotal) {
                        xml += `                <GoldTotal>${opt.goldTotal}</GoldTotal>\n`;
                    }
                    if (opt.healthTotal) {
                        xml += `                <HealthTotal>${opt.healthTotal}</HealthTotal>\n`;
                    }
                    if (opt.renownTotal) {
                        xml += `                <RenownTotal>${opt.renownTotal}</RenownTotal>\n`;
                    }

                    xml += '            </Option>\n';
                });
                xml += '        </Options>\n';
            }

            // Other properties
            if (event.weight) {
                xml += `        <WeightedChanceOfOccurring>${event.weight}</WeightedChanceOfOccurring>\n`;
            }
            if (event.minAge) {
                xml += `        <ReqHeroMinAge>${event.minAge}</ReqHeroMinAge>\n`;
            }
            if (event.maxAge) {
                xml += `        <ReqHeroMaxAge>${event.maxAge}</ReqHeroMaxAge>\n`;
            }
            if (event.reqGoldAbove) {
                xml += `        <ReqGoldAbove>${event.reqGoldAbove}</ReqGoldAbove>\n`;
            }
            if (event.reqCaptivesAbove) {
                xml += `        <ReqCaptivesAbove>${event.reqCaptivesAbove}</ReqCaptivesAbove>\n`;
            }
            if (event.reqTroopsAbove) {
                xml += `        <ReqTroopsAbove>${event.reqTroopsAbove}</ReqTroopsAbove>\n`;
            }

            xml += '    </CEEvent>\n\n';
            return xml;
        }

        function previewXML() {
            const xml = generateXML();
            document.getElementById('xmlPreviewContent').textContent = xml;
            document.getElementById('previewModal').classList.add('active');
        }

        function exportXML() {
            previewXML();
        }

        function copyXML() {
            const xml = generateXML();
            navigator.clipboard.writeText(xml).then(() => {
                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }

        function downloadXML() {
            const xml = generateXML();
            const blob = new Blob([xml], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'CustomEvents.xml';
            a.click();
            URL.revokeObjectURL(url);
            showToast('æ–‡ä»¶å·²ä¸‹è½½');
        }

        // ==================== Utilities ====================
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;');
        }

        function escapeXml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&apos;');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.borderLeftColor = type === 'error' ? 'var(--error)' : 'var(--success)';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.add-consequence')) {
                document.querySelectorAll('.consequence-dropdown').forEach(d => d.classList.remove('show'));
            }
        });

        // Initialize
        init();
    </script>
</body>
</html>
